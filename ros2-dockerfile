# ベースイメージを指定
FROM osrf/ros:humble-desktop

# 必要なパッケージをインストール
COPY apt-packages.txt /home/tmp/apt-packages.txt
RUN apt-get update && \
    xargs apt-get install -y --no-install-recommends < /home/tmp/apt-packages.txt


# 引数としてユーザー情報を受け取る
ARG USERNAME
ARG USER_UID
ARG USER_GID
ARG CONTAINER_NAME
ENV CONTAINER_NAME=${CONTAINER_NAME}

# ユーザーとグループを作成
RUN groupadd --gid $USER_GID $USERNAME \
    && useradd --uid $USER_UID --gid $USER_GID -m $USERNAME \
    && echo $USERNAME ALL=\(root\) NOPASSWD:ALL > /etc/sudoers.d/$USERNAME \
    && chmod 0440 /etc/sudoers.d/$USERNAME

# zsh をデフォルトシェルに設定
RUN chsh -s /usr/bin/zsh

WORKDIR /home/$USERNAME

USER $USERNAME

# dotfiles リポジトリをクローン
RUN git clone https://github.com/masahiro-kubota/dotfiles.git

# dotfiles ディレクトリに移動して install.sh を実行
RUN cd dotfiles && chmod +x install.sh && ./install.sh

# 作業ディレクトリを /workspace に設定
WORKDIR /workspace
RUN sudo chown $USERNAME:$USERNAME /workspace

# Zsh プロンプトをカスタマイズ
#RUN echo 'export PROMPT="%F{yellow}['${CONTAINER_NAME}']%f %F{green}%n%f:%F{blue}%~%f$ "' >> /home/$USERNAME/.zshrc

# ROS2設定
COPY cyclonedds.xml /opt/autoware/cyclonedds.xml


# 環境変数を設定 .zshrcに色々書いてるのでENVではなく.zshrcに書き込み
#RUN echo 'export CC=/usr/bin/gcc' >> /home/$USERNAME/.zshrc
#RUN echo 'export CXX=/usr/bin/g++' >> /home/$USERNAME/.zshrc

COPY entrypoint.sh /entrypoint.sh
ENTRYPOINT ["/entrypoint.sh"]

# zsh をデフォルトで起動
CMD ["zsh"]
